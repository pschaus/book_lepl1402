

<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Parallel Programming &#8212; LEPL1402  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Functional Programming" href="part6.html" />
    <link rel="prev" title="Algorithms and Data Structures" href="part4.html" />

    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-125847974-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="part6.html" title="Functional Programming"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="part4.html" title="Algorithms and Data Structures"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">LEPL1402  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Parallel Programming</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="parallel-programming">
<span id="part5"></span><h1>Parallel Programming<a class="headerlink" href="#parallel-programming" title="Permalink to this heading">¶</a></h1>
<p>Parallel programming is a computing technique where multiple tasks are executed simultaneously to achieve faster execution times and to improve resource utilization, compared to sequential execution.</p>
<p>Parallel programming involves <strong>breaking down a task into smaller sub-tasks that can be executed independently and concurrently</strong> across multiple processors, such as CPUs (central processing units), GPUs (graphics processing units), or distributed computing resources.</p>
<p>Parallel programming is often introduced as a way to optimally take advantage of the multiple computing units that are embedded in modern computers, in order to <strong>speed up some computation that takes a lot time</strong>.</p>
<p>However, besides this exploitation of multiple computing units to speed up computations, parallel programming also enables the design of <strong>responsive user interfaces</strong>. Indeed, most GUI (graphical user interface) frameworks are built on the top of a “main event loop” that continuously monitors user interactions and that calls application code to react to those events. If the application code takes too much time to run, the user interface appears to “freeze.” Parallel programming allows to run this applicative logic in the background, hereby preserving an optimal user experience.</p>
<p>This concept of “main event loop” can also be encountered in <strong>network applications</strong>, where a software must simultaneously serve requests issued by different clients. Thanks to parallel programming, each connection with a client can be handled in the background, leaving the main server able to listen to new connections.</p>
<p>Finally, it may also happen that the design of a whole software can be more naturally modeled using parallel programming than using sequential programming. Think about your personal week agenda: You have a number of distinct tasks of different natures to be achieved during the week, and those tasks only have loose dependencies between them. A large-scale software is likewise: It can generally be <strong>decomposed into a set of mostly uncoupled tasks</strong>, where each of the individual tasks has a different objective and can be solved using sequential programming. Sequential programming has indeed the advantage of being easier to write, to <a class="reference internal" href="part3.html#id1"><span class="std std-ref">test</span></a>, and to correct. Nevertheless, developing the whole software using sequential programming would introduce unnecessary, arbitrary dependencies between the individual tasks, hereby reducing the performance and increasing the complexity of the design. Parallel programming can be a solution to improve such designs.</p>
<section id="gpus-vs-cpus">
<h2>GPUs vs. CPUs<a class="headerlink" href="#gpus-vs-cpus" title="Permalink to this heading">¶</a></h2>
<p>In recent years, there is a growing interest in the exploitation of GPUs to carry on computations that are not related to computer graphics. Indeed, <strong>GPUs</strong> consist of a massive number of processing units working in parallel that are highly optimized for certain types of computations, especially those involving graphics rendering, heavy matrix operations, numerical simulations, and deep learning.</p>
<p>However, while GPUs are incredibly powerful for certain types of parallel computations, they are not a universal replacement for CPUs. Indeed, CPUs are much more versatile, as they are designed to handle a wide range of tasks, including general-purpose computing, running operating systems, managing I/O operations, executing single-threaded applications, and handling diverse workloads. In contrast, the processing units of GPUs focus on simpler, identical tasks that can be duplicated a large number of times. Furthermore, certain types of tasks, particularly those with sequential dependencies or requiring frequent access to shared data, might not benefit significantly from GPU acceleration. Finally, writing code for GPUs often requires the usage of specialized programming languages or libraries and the understanding of the underlying hardware architecture.</p>
<p>Consequently, in this course, we will only focus on <strong>parallel programming on CPUs</strong>. It is indeed essential to notice that thanks to hardware evolution, any consumer computer is nowadays equipped with multiple CPU cores (even if they are less numerous than processing units inside a GPU), as depicted on the following picture:</p>
<a class="reference internal image-reference" href="_images/gpu-vs-cpu.svg"><img alt="GPU vs. CPU" class="align-center" src="_images/gpu-vs-cpu.svg" width="75%" /></a>
<p>Parallel programming on CPU seeks to leverage the multiple CPU cores available inside a single computer to execute multiple tasks or portions of a single task simultaneously.</p>
</section>
<section id="multiprocessing-vs-multithreading">
<span id="multithreading"></span><h2>Multiprocessing vs. multithreading<a class="headerlink" href="#multiprocessing-vs-multithreading" title="Permalink to this heading">¶</a></h2>
<p>In computing, a <strong>process</strong> corresponds to a program that is actively running on the CPU of a computer, along with its current state. A typical operating system allows multiple independent processes to run concurrently on the available CPU cores, hereby providing an environment to achieve parallelism that is referred to as <strong>multiprocessing</strong>.</p>
<p>A process has its own memory space (including code, data, stack, and CPU registers) and its own resources that are isolated from other processes to prevent unauthorized access and interference. Distinct processes may still communicate with each other through the so-called <strong>“interprocess communication” (IPC)</strong> mechanisms provided by the operating system. IPCs include files, pipes, message passing, shared memory, and network communications (sockets).</p>
<p>Multiprocessing has two main downsides. Firstly, creating new processes incurs a high overhead due to the need for separate memory allocation and setup for each process. Secondly, because the different processes are isolated from each other, interprocess communications are relatively complex and come at a non-negligible cost.</p>
<p>This motivates the introduction of the concept of a <strong>thread</strong>. A thread refers to the smallest unit of execution within a process: A thread corresponds to a sequence of instructions that can be scheduled and executed independently by one CPU core. One single process can run multiple threads, as illustrated below:</p>
<a class="reference internal image-reference" href="_images/threads.svg"><img alt="Multithreading" class="align-center" src="_images/threads.svg" width="50%" /></a>
<p>In this picture, the blue blocks indicate at which moment the different threads are active (i.e., are executing something) within the process. A thread can indeed “fall asleep” while waiting for additional data to process, while waiting for user interaction, or while waiting for the result of a computation done by another thread.</p>
<p>Accordingly, <strong>multithreading</strong> is a programming technique where a single process is divided into multiple threads of execution. Threads can perform different operations concurrently, such as doing a computation in the background or handling different parts of the application (e.g., keeping the user interface responsive or serving requests from multiple clients).</p>
<p>Importantly, contrarily to processes, <strong>threads within the same process are not isolated</strong>: They share the same memory space and resources, which allows distinct threads to directly access the same variables and data structures. Threads are sometimes called <em>lightweight processes</em>, because creating threads within a process incurs less overhead compared to creating separate processes.</p>
<p>Summarizing, multithreading tends to be simpler and more lightweight than multiprocessing. This explains why this course will only cover the <strong>basics of multithreading in Java</strong>.</p>
<p>It is always worth remembering that the fact that different threads do not live in isolation can be error-prone. Multithreading notably requires the introduction of suitable synchronization and coordination mechanisms between threads when accessing shared variables. If not properly implemented, <strong>race conditions, deadlocks, and synchronization issues can emerge</strong>, which can be extremely hard to identify and resolve.</p>
<p>Also, note that all programmers are constantly confronted with threads. Indeed, even if you never explicitly create a thread by yourself, the vast majority of software frameworks (such as GUI frameworks and a software libraries that deal with network programming or scientific computations) will create threads on your behalf. For instance, in the context of Java-based GUI, both the <a class="reference internal" href="part2.html#awt-swing"><span class="std std-ref">AWT (Abstract Window Toolkit) and the Swing frameworks</span></a> will transparently create threads to handle the interactions with the user. Consequently, parallel programming should never be considered as an “advanced feature” of a programming language, because almost any software development has to deal with threads. In other words, even if you do not create your own threads, it is important to understand how to design thread-safe applications that properly coordinate the accesses to the shared memory space.</p>
</section>
<section id="threads-in-java">
<span id="runnable"></span><h2>Threads in Java<a class="headerlink" href="#threads-in-java" title="Permalink to this heading">¶</a></h2>
<p>Java provides extensive support of multithreading.</p>
<p>When a Java program starts its execution, the Java Virtual Machine (JVM) starts an initial thread. This initial thread is called the <strong>main thread</strong> and is responsible for the execution of the <code class="docutils literal notranslate"><span class="pre">main()</span></code> method, which is the <a class="reference internal" href="part1.html#java-main"><span class="std std-ref">entry point of most Java applications</span></a>. Alongside the main thread, the JVM also start some private background threads for its own housekeeping (most notably the garbage collector).</p>
<p>Additional threads can then be created by software developers in two different ways:</p>
<ul class="simple">
<li><p>By <a class="reference internal" href="part2.html#inheritance"><span class="std std-ref">extending</span></a> the standard class <code class="docutils literal notranslate"><span class="pre">Thread</span></code>. Note that since <code class="docutils literal notranslate"><span class="pre">Thread</span></code> belongs to the <code class="docutils literal notranslate"><span class="pre">java.lang</span></code> package, no <code class="docutils literal notranslate"><span class="pre">import</span></code> directive is needed. Here is the documentation of the <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html">https://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html</a></p></li>
<li><p>By <a class="reference internal" href="part2.html#interfaces"><span class="std std-ref">implementing</span></a> the standard interface <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> that is also part of the <code class="docutils literal notranslate"><span class="pre">java.lang</span></code> package: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/lang/Runnable.html">https://docs.oracle.com/javase/8/docs/api/java/lang/Runnable.html</a></p></li>
</ul>
<p>In this course, we will use the second approach. The <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface is quite intuitive:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This snippet indicates that to create a thread, we first have to define a class providing a <code class="docutils literal notranslate"><span class="pre">run()</span></code> method that will take care of the computations. Once a concrete class implementing this <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface is available, it can be executed as a thread by instantiating an object of the <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class.</p>
<section id="using-a-thread-to-compute-the-minimum">
<span id="mincomputation"></span><h3>Using a thread to compute the minimum<a class="headerlink" href="#using-a-thread-to-compute-the-minimum" title="Permalink to this heading">¶</a></h3>
<p>As an illustration, let us consider the task of computing the minimum value of an array of floating-point numbers. It is straightforward to implement a sequential method to do this computation:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeMinValue</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This is an empty array&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// One could have written more compactly: minValue = Math.min(minValue, values[i]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Minimum value: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">minValue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As explained above, if one wishes to run this computation as a background thread, the <code class="docutils literal notranslate"><span class="pre">computeMinValue()</span></code> method must wrapped inside some implementation of the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface. But the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface does not accept any parameter, so we cannot directly give the <code class="docutils literal notranslate"><span class="pre">values</span></code> array as an argument to <code class="docutils literal notranslate"><span class="pre">run()</span></code>. The trick is to store a reference to the <code class="docutils literal notranslate"><span class="pre">values</span></code> array inside the class that implements <code class="docutils literal notranslate"><span class="pre">Runnable</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinComputation</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinComputation</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">computeMinValue</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">MinComputation</span></code> class specifies how to compute the minimum of an array. We can evidently run this computation in a purely sequential way as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">Runnable</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinComputation</span><span class="p">(</span><span class="n">values</span><span class="p">);</span>
<span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// This prints: &quot;Minimum value: -5.0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example, no additional thread was created besides the main Java thread. Thanks to the fact that <code class="docutils literal notranslate"><span class="pre">MinComputation</span></code> implements <code class="docutils literal notranslate"><span class="pre">Runnable</span></code>, it is now possible to compute the minimum in a separate thread:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// First, create a thread that specifies the computation to be done</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinComputation</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Secondly, start the thread</span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ...at this point, the main thread can do other stuff...</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This is the main thread&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Thirdly, wait for the thread to complete its computation</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Unexpected interrupt&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;All threads have finished&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As can be seen in this example, doing a computation in a background thread involves three main steps:</p>
<ol class="arabic simple">
<li><p>Construct an object of the class <code class="docutils literal notranslate"><span class="pre">Thread</span></code> out of an object that implements the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface.</p></li>
<li><p>Launch the thread by using the <code class="docutils literal notranslate"><span class="pre">start()</span></code> method of <code class="docutils literal notranslate"><span class="pre">Thread</span></code>. The constructor of <code class="docutils literal notranslate"><span class="pre">Thread</span></code> does not automatically start the thread, so we have to do this manually.</p></li>
<li><p>Wait for the completion of the thread by calling the <code class="docutils literal notranslate"><span class="pre">join()</span></code> method of <code class="docutils literal notranslate"><span class="pre">Thread</span></code>. Note that <code class="docutils literal notranslate"><span class="pre">join()</span></code> can throw an <code class="docutils literal notranslate"><span class="pre">InterruptedException</span></code>, which happens if the thread is interrupted by something.</p></li>
</ol>
<p>The following sequence diagram (loosely inspired from <a class="reference external" href="https://en.wikipedia.org/wiki/Unified_Modeling_Language">UML</a>) depicts this sequence of calls:</p>
<a class="reference internal image-reference" href="_images/sequence-thread.svg"><img alt="Sequence diagram of the computation of the minimum" class="align-center" src="_images/sequence-thread.svg" width="80%" /></a>
<p>In this diagram, the white bands indicate the moments where the different objects are executing code. It can be seen that between the two calls <code class="docutils literal notranslate"><span class="pre">t.start()</span></code> and <code class="docutils literal notranslate"><span class="pre">t.join()</span></code>, two threads are simultaneously active: the main thread and the computation thread. Note that once the main thread calls <code class="docutils literal notranslate"><span class="pre">t.join()</span></code>, it falls asleep until the computation thread finishes its work.</p>
<p>In other words, the <code class="docutils literal notranslate"><span class="pre">t.join()</span></code> call is a form of <strong>synchronization</strong> between threads. It is always a good idea for the main Java thread to wait for all of its child threads by calling <code class="docutils literal notranslate"><span class="pre">join()</span></code> on each of them. If a child thread launches its own set of sub-threads, it is highly advised for this child thread to call <code class="docutils literal notranslate"><span class="pre">join()</span></code> of each of its sub-threads before ending. The Java process will end if all its threads have ended, including the main thread.</p>
</section>
<section id="keeping-user-interfaces-responsive">
<span id="responsive"></span><h3>Keeping user interfaces responsive<a class="headerlink" href="#keeping-user-interfaces-responsive" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MinComputation</span></code> example creates one background thread to run a computation on a array. As explained in the <a class="reference internal" href="#part5"><span class="std std-ref">introduction</span></a>, this software architecture can have an interest to keep the user interface responsive during some long computation. To illustrate this interest, consider a <a class="reference internal" href="part2.html#awt-swing"><span class="std std-ref">GUI application</span></a> with three buttons using Swing:</p>
<a class="reference internal image-reference" href="_images/swing.png"><img alt="Swing application with 3 buttons" class="align-center" src="_images/swing.png" style="width: 320px;" /></a>
<p>The corresponding source code is:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.GridLayout</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.event.ActionEvent</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.awt.event.ActionListener</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.swing.JButton</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.swing.JFrame</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.swing.JOptionPane</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">javax.swing.JPanel</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">SayHello</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ActionListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">actionPerformed</span><span class="p">(</span><span class="n">ActionEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello world!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ButtonThread</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">JFrame</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JFrame</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">frame</span><span class="p">.</span><span class="na">setSize</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">200</span><span class="p">);</span>
<span class="w">        </span><span class="n">frame</span><span class="p">.</span><span class="na">setDefaultCloseOperation</span><span class="p">(</span><span class="n">JFrame</span><span class="p">.</span><span class="na">DISPOSE_ON_CLOSE</span><span class="p">);</span>

<span class="w">        </span><span class="n">JPanel</span><span class="w"> </span><span class="n">panel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JPanel</span><span class="p">();</span>
<span class="w">        </span><span class="n">panel</span><span class="p">.</span><span class="na">setLayout</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">GridLayout</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">        </span><span class="n">frame</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">panel</span><span class="p">);</span>

<span class="w">        </span><span class="n">JButton</span><span class="w"> </span><span class="n">button1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JButton</span><span class="p">(</span><span class="s">&quot;Say hello!&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">button1</span><span class="p">.</span><span class="na">addActionListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SayHello</span><span class="p">());</span>
<span class="w">        </span><span class="n">panel</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">button1</span><span class="p">);</span>

<span class="w">        </span><span class="n">JButton</span><span class="w"> </span><span class="n">button2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JButton</span><span class="p">(</span><span class="s">&quot;Run the computation without a thread&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">button2</span><span class="p">.</span><span class="na">addActionListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RunWithoutThread</span><span class="p">());</span>
<span class="w">        </span><span class="n">panel</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">button2</span><span class="p">);</span>

<span class="w">        </span><span class="n">JButton</span><span class="w"> </span><span class="n">button3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JButton</span><span class="p">(</span><span class="s">&quot;Run the computation using a thread&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">button3</span><span class="p">.</span><span class="na">addActionListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RunUsingThread</span><span class="p">());</span>
<span class="w">        </span><span class="n">panel</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">button3</span><span class="p">);</span>

<span class="w">        </span><span class="n">frame</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once the user clicks on the “Say hello!” button, a message box appears saying “Hello world!”. Let us now implement the button entitled “Run the computation without a thread”. In the <code class="docutils literal notranslate"><span class="pre">ActionListener</span></code> observer associated with this button, a long computation is emulated by waiting for 3 seconds:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">expensiveComputation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">JOptionPane</span><span class="p">.</span><span class="na">showMessageDialog</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Phew! I&#39;ve finished my hard computation!&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">RunWithoutThread</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ActionListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">actionPerformed</span><span class="p">(</span><span class="n">ActionEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">expensiveComputation</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you try and run this example, if clicking on this second button, it becomes impossible to do any other interaction with the “Say hello!” button. The user interface is totally frozen until the <code class="docutils literal notranslate"><span class="pre">expensiveComputation()</span></code> method finishes its work.</p>
<p>In order to turn this non-responsive application into a responsive application, one can simply start a thread that runs the <code class="docutils literal notranslate"><span class="pre">expensiveComputation()</span></code> method:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">Computation</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">expensiveComputation</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">RunUsingThread</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ActionListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">actionPerformed</span><span class="p">(</span><span class="n">ActionEvent</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Computation</span><span class="p">());</span>
<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way, even when the computation is running, it is still possible to click on “Say hello!”.</p>
</section>
<section id="speeding-up-the-computation">
<span id="minblockcomputation"></span><h3>Speeding up the computation<a class="headerlink" href="#speeding-up-the-computation" title="Permalink to this heading">¶</a></h3>
<p>Even though starting a background thread can be interesting to improve the responsiveness of an application (<a class="reference internal" href="#responsive"><span class="std std-ref">as illustrated above</span></a>), this does not speed up the computation. For instance, the time that is necessary to <a class="reference internal" href="#mincomputation"><span class="std std-ref">compute the minimum value</span></a> using <code class="docutils literal notranslate"><span class="pre">MinComputation</span></code> is still the same as the purely sequential implementation of method <code class="docutils literal notranslate"><span class="pre">computeMinValue()</span></code>. In order to reduce the computation time, it is needed to modify the sequential algorithm so that it can exploit multiple CPU cores.</p>
<p>For algorithms working on an array, the basic idea is to split the array in two parts, then to process each of those parts by two distinct threads:</p>
<a class="reference internal image-reference" href="_images/array-threads.svg"><img alt="Splitting an array to improve performance" class="align-center" src="_images/array-threads.svg" width="80%" /></a>
<p>Once the two threads have finished their work, we need to <strong>combine</strong> their results to get the final result. In our example, the minimum of the whole array is the minimum of the two minimums computed on the two parts.</p>
<p>To implement this solution, the class that implements the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface must not only receive the <code class="docutils literal notranslate"><span class="pre">values</span></code> array, but it must also receive the start index and the end index of the block of interest in the array. Furthermore, the class must not <em>print</em> the minimum, but must provide access to computed minimum value in either block. This is implemented in the following code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinBlockComputation</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinBlockComputation</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;Empty array&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">minValue</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that we now have to throw an exception if the array is empty, because the minimum is not defined in this case. In the previous implementation, we simply printed out the information. This is not an appropriate solution anymore, as we have to provide an access to the computed minimum value.</p>
<p>Thanks to this new design, it is now possible to speed up the computation the minimum using two threads:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="n">MinBlockComputation</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">MinBlockComputation</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>

<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>

<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>

<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Minimum is: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">c1</span><span class="p">.</span><span class="na">getMinValue</span><span class="p">(),</span><span class="w"> </span><span class="n">c2</span><span class="p">.</span><span class="na">getMinValue</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The implementation works as follows:</p>
<ol class="arabic simple">
<li><p>We define the two computations <code class="docutils literal notranslate"><span class="pre">c1</span></code> and <code class="docutils literal notranslate"><span class="pre">c2</span></code> that must be carried on the two parts of the whole array. Importantly, the computations are only <em>defined</em>, the minimum is not computed at this point.</p></li>
<li><p>We create and launch two threads <code class="docutils literal notranslate"><span class="pre">t1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code> that will respectively be in charge of calling the <code class="docutils literal notranslate"><span class="pre">c1.run()</span></code> and <code class="docutils literal notranslate"><span class="pre">c2.run()</span></code> methods. In other words, it is only <em>after</em> the calls to <code class="docutils literal notranslate"><span class="pre">t1.start()</span></code> and <code class="docutils literal notranslate"><span class="pre">t2.start()</span></code> that the search for the minimum begins.</p></li>
<li><p>Once the two threads have finished their work, the main thread collects the partial results from <code class="docutils literal notranslate"><span class="pre">c1</span></code> and <code class="docutils literal notranslate"><span class="pre">c2</span></code>, then combines these partial results in order to print the final result.</p></li>
</ol>
<p>Also note that this version does not catch the possible <code class="docutils literal notranslate"><span class="pre">InterruptedException</span></code>, but reports it to the caller.</p>
</section>
<section id="dealing-with-empty-parts">
<span id="minmaxresult"></span><h3>Dealing with empty parts<a class="headerlink" href="#dealing-with-empty-parts" title="Permalink to this heading">¶</a></h3>
<p>Even though the implementation from the previous section works fine on arrays containing at least 2 elements, it fails if the <code class="docutils literal notranslate"><span class="pre">values</span></code> array is empty or only contains 1 element. Indeed, in this case, <code class="docutils literal notranslate"><span class="pre">values.length</span> <span class="pre">/</span> <span class="pre">2</span> <span class="pre">==</span> <span class="pre">0</span></code>, which throws the <code class="docutils literal notranslate"><span class="pre">IllegalArgumentException</span></code> in the constructor of <code class="docutils literal notranslate"><span class="pre">c1</span></code>. Furthermore, if <code class="docutils literal notranslate"><span class="pre">values.length</span> <span class="pre">==</span> <span class="pre">0</span></code>, the constructor of <code class="docutils literal notranslate"><span class="pre">c2</span></code> would launch the same exception.</p>
<p>One could solve this problem by conditioning the creation of <code class="docutils literal notranslate"><span class="pre">c1</span></code>, <code class="docutils literal notranslate"><span class="pre">c2</span></code>, <code class="docutils literal notranslate"><span class="pre">t1</span></code>, and <code class="docutils literal notranslate"><span class="pre">t2</span></code> according to the value of <code class="docutils literal notranslate"><span class="pre">values.length</span></code>. This would however necessitate to deal with multiple cases that are difficult to write and maintain. This problem would also be exacerbated if we decide to divide the array into more than 2 parts to better exploit the available CPU cores.</p>
<p>A simpler, more scalable solution consists in introducing a Boolean flag that indicates whether a result is present for each part of the array. Instead of throwing the <code class="docutils literal notranslate"><span class="pre">IllegalArgumentException</span></code> in the constructor, this flag would be set to <code class="docutils literal notranslate"><span class="pre">false</span></code> if the search for minimum is launched on an empty block.</p>
<p>To illustrate this idea, let us consider the slightly more complex problem of computing both the minimum and the maximum values of an array. The first step is to define a class that will hold the result of a computation:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinMaxResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">MinMaxResult</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPresent</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">isPresent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinMaxResult</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="kc">true</span><span class="w"> </span><span class="cm">/* present */</span><span class="p">,</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="nf">empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">(</span><span class="kc">false</span><span class="w"> </span><span class="cm">/* not present */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* dummy min */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* dummy max */</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isPresent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMaxValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">getMaxValue</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Empty array&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">with</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="p">.</span><span class="na">isPresent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Combine the results from two non-empty blocks</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">minValue</span><span class="p">);</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">maxValue</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Replace the currently absent result by the provided result</span>
<span class="w">                </span><span class="n">isPresent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">minValue</span><span class="p">;</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">maxValue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Do nothing if the other result is absent</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Introducing the <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> class allows us to cleanly separate the two distinct concepts of the “<em>algorithm to do a computation</em>” and of the “<em>results of the computation</em>.” This separation is another example of a <a class="reference internal" href="part4.html#part4"><span class="std std-ref">design pattern</span></a>.</p>
<p>As can be seen in the source code, there are two possible ways to create an object of the <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> class:</p>
<ul class="simple">
<li><p>either by using the <code class="docutils literal notranslate"><span class="pre">MinMaxResult(minValue,</span> <span class="pre">maxValue)</span></code> constructor, which sets the <code class="docutils literal notranslate"><span class="pre">isPresent</span></code> flag to <code class="docutils literal notranslate"><span class="pre">true</span></code> in order to indicate the presence of a result,</p></li>
<li><p>or by using the <code class="docutils literal notranslate"><span class="pre">MinMaxResult.empty()</span></code> static method, that creates a <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> object with the <code class="docutils literal notranslate"><span class="pre">isPresent</span></code> flag set to <code class="docutils literal notranslate"><span class="pre">false</span></code> in order to indicate the absence of a result (this is the case of an empty block).</p></li>
</ul>
<p>The object throws an exception if trying to access the minimum or the maximum values if the result is absent. It is up to the caller to check the presence of a result using the <code class="docutils literal notranslate"><span class="pre">isPresent()</span></code> method, before calling <code class="docutils literal notranslate"><span class="pre">getMinValue()</span></code> or <code class="docutils literal notranslate"><span class="pre">getMaxValue()</span></code>.</p>
<p>Finally, note the presence of the <code class="docutils literal notranslate"><span class="pre">combine()</span></code> method. This method updates the currently available minimum/maximum values with the results obtained from a different block. The <code class="docutils literal notranslate"><span class="pre">combine()</span></code> implements the combination of two partial results.</p>
<p>It is now possible to create an implementation of the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface that leverages <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinMaxBlockComputation</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinMaxBlockComputation</span><span class="p">(</span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="nf">getResult</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> class is essentially the same as the <code class="docutils literal notranslate"><span class="pre">MinBlockComputation</span></code> class <a class="reference internal" href="#minblockcomputation"><span class="std std-ref">defined earlier</span></a>. It only differs in the way the result is stored: <code class="docutils literal notranslate"><span class="pre">MinBlockComputation</span></code> uses a <code class="docutils literal notranslate"><span class="pre">float</span></code> to hold the result of the computation on a block, whereas <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> uses an object of the <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> class. This allows <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> not only to report both the minimum and maximum values of part of an array, but also to indicate whether that part was empty or non-empty.</p>
<p>It is now easy to run the computation using two threads in a way that is also correct when the <code class="docutils literal notranslate"><span class="pre">values</span></code> array contains 0 or 1 element:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>

<span class="w">    </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c1</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">c2</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="optional-results">
<h3>Optional results<a class="headerlink" href="#optional-results" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> class <a class="reference internal" href="#minmaxresult"><span class="std std-ref">was previously introduced</span></a> as a way to deal with the absence of a result in the case of an empty part of an array. More generally, dealing with the absence of a value is a common pattern in software architectures. For this reason, Java introduces the <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> generic class: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html</a></p>
<p>The <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> class does exactly the same stuff as the <code class="docutils literal notranslate"><span class="pre">isPresent</span></code> Boolean flag that we manually introduced into the <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> class. The four main operations of <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">of(T</span> <span class="pre">t)</span></code> is a static method that constructs an <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> object embedding the given object <code class="docutils literal notranslate"><span class="pre">t</span></code> of class <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">empty()</span></code> is a static method that constructs an <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> object indicating the absence of an object of class <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">isPresent()</span></code> is a method that indicates whether the <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> object contains an object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get()</span></code> returns the embedded object of class <code class="docutils literal notranslate"><span class="pre">T</span></code>. If the <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code> does not contains an object, an exception is thrown.</p></li>
</ul>
<p>Consequently, we could have defined a simplified version of <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> without the <code class="docutils literal notranslate"><span class="pre">isPresent</span></code> Boolean flag as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinMaxResult2</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinMaxResult2</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                         </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMaxValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By combining <code class="docutils literal notranslate"><span class="pre">MinMaxResult2</span></code> with <code class="docutils literal notranslate"><span class="pre">Optional&lt;T&gt;</span></code>, the sequential algorithm to be integrated inside the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> class could have been rewritten as:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MinMaxResult2</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">computeMinMaxSequential</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="p">,</span>
<span class="w">                                                              </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                                                              </span><span class="kt">int</span><span class="w"> </span><span class="n">stopIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">stopIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">stopIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxResult2</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MinMaxResult2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeMinMaxSequential</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getMaxValue</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Empty array&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This alternative implementation would have been slightly shorter and would have avoided any possible bug in our manual implementation of the <code class="docutils literal notranslate"><span class="pre">isPresent</span></code> flag.</p>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>Reimplement the <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> class by replacing <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> with <code class="docutils literal notranslate"><span class="pre">Optional&lt;MinMaxResult2&gt;</span></code>, and launch threads based on this new class.</p>
</div>
</section>
</section>
<section id="thread-pools">
<span id="id1"></span><h2>Thread pools<a class="headerlink" href="#thread-pools" title="Permalink to this heading">¶</a></h2>
<p>So far, we have only created two threads, but a modern CPU will typically have at least 4 cores. One could launch more threads to benefit from those additional cores. For instance, the following code would use 4 threads by dividing the array in 4 parts:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">);</span>
<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">);</span>
<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">);</span>
<span class="w">    </span><span class="n">MinMaxBlockComputation</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockComputation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c3</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c4</span><span class="p">);</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t3</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t4</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t3</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t4</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>

<span class="w">    </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">c1</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">c2</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">c3</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">c4</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the definition of <code class="docutils literal notranslate"><span class="pre">c4</span></code> uses the size of the array (i.e., <code class="docutils literal notranslate"><span class="pre">values.length</span></code>) as its stop index, instead of <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">blockSize</span></code>, in order to be sure that the last items in the array get processed if the size of the array is not a multiple of 4.</p>
<p>We could continue adding more threads in this way (for instance, 8, 16, 32…). But if we use, say, 100 threads, does that mean that our program will run 100 faster? The answer is no, for at least two reasons:</p>
<ul class="simple">
<li><p>Obviously, the level of parallelism is limited by the number of CPU cores that are available. If using a CPU with 4 cores, you cannot expect a speed up of more than 4.</p></li>
<li><p>Even if threads are lightweight, there is still an overhead associated with the creation and management of a thread. On a modern computer, creating a simple thread (without any extra object) takes around 0.05-0.1 ms. That is approximately the time to calculate the sum from 1 to 100,000.</p></li>
</ul>
<p>We can conclude that threads only improve the speed of a program if the tasks for the threads are longer than the overhead to create and manage them. This motivates the introduction of <strong>thread pools</strong>. A thread pool is a group of threads that are ready to work:</p>
<a class="reference internal image-reference" href="_images/thread-pool.svg"><img alt="Thread pool" class="align-center" src="_images/thread-pool.svg" width="80%" /></a>
<p>In this drawing, we have a thread pool that is made of 2 threads. Those threads are continuously monitoring a queue of pending tasks. As soon as some task is enqueued and as soon as some thread becomes available, the available thread takes care of this task. Once the task is over, the thread informs the caller that the result of the task is available, then it goes back to listening to the queue, waiting for a new task to be processed.</p>
<p>Thread pools are an efficient way to avoid the overhead associated with the initialization and finalization of threads. It also allows to write user code that is uncoupled from the number of threads or from the number of CPU cores.</p>
<section id="thread-pools-in-java">
<h3>Thread pools in Java<a class="headerlink" href="#thread-pools-in-java" title="Permalink to this heading">¶</a></h3>
<p>In Java, three different interfaces are generally combined to create a thread pool:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">java.util.concurrent.ExecutorService</span></code> implements the thread pool itself, including the queue of requests and its background threads: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">java.util.concurrent.Callable&lt;T&gt;</span></code> is a generic interface that represents the task to be run. The task must return an object of type <code class="docutils literal notranslate"><span class="pre">T</span></code>: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Callable.html</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">java.util.concurrent.Future&lt;T&gt;</span></code> is a generic interface that represents the result of a task that is in the process of being computed: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html</a>.</p></li>
</ul>
<p>The <a class="reference internal" href="part1.html#jdk"><span class="std std-ref">Java Development Kit (JDK)</span></a> provides concrete implementations of <code class="docutils literal notranslate"><span class="pre">ExecutorService</span></code> and <code class="docutils literal notranslate"><span class="pre">Future</span></code>, so we (fortunately!) do not have to implement them by ourselves. A concrete thread pool can be created as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="cm">/* numberOfThreads */</span><span class="p">);</span>
</pre></div>
</div>
<p>As developers, our sole responsibility consists in choosing the generic type <code class="docutils literal notranslate"><span class="pre">T</span></code> and in providing an implementation of interface <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> that describes the task to be achieved. The interface <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> looks as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">call</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This looks extremely similar to the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface that <a class="reference internal" href="#runnable"><span class="std std-ref">we have been using so far</span></a>! The difference between the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> and a <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> interfaces is that the former has no return value, whereas the latter returns a result of type <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p>
<p>Once a concrete implementation of <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> is available, tasks can be submitted to the thread pool. The pattern is as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyCallable</span><span class="p">(...));</span>
</pre></div>
</div>
<p>Threads in thread pool are like chefs in the kitchen of a restaurant waiting for orders. If you submit one task to the pool using the call above, one of the chefs will take the task and it will immediately start working on it. You can submit more tasks, but they might have to wait until one chef has finished dealing with its current task:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyCallable</span><span class="p">(...));</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyCallable</span><span class="p">(...));</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyCallable</span><span class="p">(...));</span>
<span class="c1">// ...</span>
</pre></div>
</div>
<p>You can obtain the result of the futures with their <code class="docutils literal notranslate"><span class="pre">get()</span></code> method:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="w"> </span><span class="n">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future1</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="n">T</span><span class="w"> </span><span class="n">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future2</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="n">T</span><span class="w"> </span><span class="n">result3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future3</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="n">T</span><span class="w"> </span><span class="n">result4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future4</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="c1">// ...</span>
</pre></div>
</div>
<p>If the task is not finished yet, the method <code class="docutils literal notranslate"><span class="pre">get()</span></code> will wait. This contrast with the <code class="docutils literal notranslate"><span class="pre">executor.submit()</span></code> method that always returns immediately.</p>
<p>At the end of the program or when you do not need the thread pool anymore, you have to shut it down explicitly to stop all its threads, otherwise the software might not properly exit:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="thread-pool-for-computing-the-minimum-and-maximum">
<h3>Thread pool for computing the minimum and maximum<a class="headerlink" href="#thread-pool-for-computing-the-minimum-and-maximum" title="Permalink to this heading">¶</a></h3>
<p>It is straightforward to turn the <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> runnable that <a class="reference internal" href="#minmaxresult"><span class="std std-ref">was defined above</span></a> into an callable:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MinMaxBlockCallable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">MinMaxResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Removed member: MinMaxResult result;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MinMaxBlockCallable</span><span class="p">(</span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The only differences are:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface is replaced by the <code class="docutils literal notranslate"><span class="pre">Callable&lt;MinMaxResult&gt;</span></code> interface.</p></li>
<li><p>The method <code class="docutils literal notranslate"><span class="pre">run()</span></code> is replaced by method <code class="docutils literal notranslate"><span class="pre">call()</span></code>.</p></li>
<li><p>The member variable <code class="docutils literal notranslate"><span class="pre">result</span></code> and the method <code class="docutils literal notranslate"><span class="pre">getResult()</span></code> are removed. These elements are replaced by the return value of <code class="docutils literal notranslate"><span class="pre">call()</span></code>.</p></li>
</ul>
<p>Thanks to the newly defined <code class="docutils literal notranslate"><span class="pre">MinMaxBlockCallable</span></code> class, it is now possible to use a thread pool:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">ExecutionException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Create a thread pool with 4 threads (the thread pool could be shared with other methods)</span>
<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="c1">// Create two tasks that work on two distinct parts of the whole array</span>
<span class="w">    </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">MinMaxResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partialResult1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockCallable</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="w">    </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">MinMaxResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partialResult2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockCallable</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Combine the partial results on the two parts to get the final result</span>
<span class="w">    </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">finalResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">    </span><span class="n">finalResult</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">partialResult1</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">  </span><span class="c1">// This call blocks the main thread until the first part is processed</span>
<span class="w">    </span><span class="n">finalResult</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">partialResult2</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">  </span><span class="c1">// This call blocks the main thread until the second part is processed</span>
<span class="w">    </span><span class="n">finalResult</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Do not forget to shut down the thread pool</span>
<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This solution looks extremely similar to the previous solution using <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> and <code class="docutils literal notranslate"><span class="pre">Thread</span></code>. However, in this code, we do not have to manage the threads by ourselves, and the thread pool could be shared with other parts of the software.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">throws</span></code> construction is needed because the <code class="docutils literal notranslate"><span class="pre">get()</span></code> method of futures can possibly throw an <code class="docutils literal notranslate"><span class="pre">InterruptedException</span></code> (if the future was interrupted while waiting) or an <code class="docutils literal notranslate"><span class="pre">ExecutionException</span></code> (if there was a problem during the calculation).</p>
</section>
<section id="dividing-the-array-into-multiple-blocks">
<span id="pool-multiple-blocks"></span><h3>Dividing the array into multiple blocks<a class="headerlink" href="#dividing-the-array-into-multiple-blocks" title="Permalink to this heading">¶</a></h3>
<p>So far, we have divided the array <code class="docutils literal notranslate"><span class="pre">values</span></code> into 2 or 4 blocks, because we were guided by the number of CPU cores. In practice, it is a better idea to divide the array into blocks of a fixed size to become agnostic of the underlying number of cores. A thread pool can be used in this situation to manage the computations, while preventing the number of threads to exceed the CPU capacity.</p>
<p>To this end, we can create a separate data structure (e.g., a stack or a list) that keeps track of the pending computations by storing the <code class="docutils literal notranslate"><span class="pre">Future&lt;MinMaxResult&gt;</span></code> objects:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">ExecutionException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">blockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>

<span class="w">    </span><span class="n">Stack</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">MinMaxResult</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pendingComputations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stack</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberOfBlocks</span><span class="p">;</span><span class="w"> </span><span class="n">block</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">numberOfBlocks</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockSize</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxBlockCallable</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">MinMaxResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partialResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<span class="w">        </span><span class="n">result</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">partialResult</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>

<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the end index of the last block is treated specifically, because <code class="docutils literal notranslate"><span class="pre">values.length</span></code> might not be an integer multiple of <code class="docutils literal notranslate"><span class="pre">blockSize</span></code>.</p>
</section>
<section id="computing-the-mean-of-an-array">
<h3>Computing the mean of an array<a class="headerlink" href="#computing-the-mean-of-an-array" title="Permalink to this heading">¶</a></h3>
<p>Up to now, this chapter has been almost entirely focused on the task of finding the minimum and maximum values in an array. We have explained how the introduction of the separate class <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> that is dedicated to the storage of partial results leads to a natural use of thread pools by implementing the <code class="docutils literal notranslate"><span class="pre">Callable&lt;MinMaxResult&gt;</span></code> interface. An important trick was to define the <code class="docutils literal notranslate"><span class="pre">combine()</span></code> method that is responsible for combining the partial results obtained from different parts of the array.</p>
<p>How could we compute the mean of the array using a similar approach?</p>
<p>The first thing is to define a class that stores the partial result over a block of the array. One could decide to store only the mean value itself. Unfortunately, this choice would not give enough information to implement the <code class="docutils literal notranslate"><span class="pre">combine()</span></code> method. Indeed, in order to combine two means, it is necessary to know the number of elements upon which the individual means were computed.</p>
<p>The solution consists in storing the sum and the number of elements in a dedicated class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MeanResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span><span class="w">  </span><span class="c1">// We use doubles as we might be summing a large number of floats</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MeanResult</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addValue</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isPresent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMean</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="n">MeanResult</span><span class="w"> </span><span class="n">with</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">sum</span><span class="p">;</span>
<span class="w">        </span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">count</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getMean</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Empty array&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Thanks to the <code class="docutils literal notranslate"><span class="pre">MeanResult</span></code> class, the source code of <code class="docutils literal notranslate"><span class="pre">MinMaxBlockCallable</span></code> can be adapted in order to define a callable that computes the mean of a block of an array:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MeanUsingCallable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">MeanResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MeanUsingCallable</span><span class="p">(</span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">,</span>
<span class="w">                             </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                             </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MeanResult</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MeanResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MeanResult</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="p">.</span><span class="na">addValue</span><span class="p">(</span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This callable can be used as a drop-in replacement in the <a class="reference internal" href="#pool-multiple-blocks"><span class="std std-ref">source code to compute the minimum/maximum</span></a>.</p>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>The classes <code class="docutils literal notranslate"><span class="pre">MinMaxBlockCallable</span></code> and <code class="docutils literal notranslate"><span class="pre">MeanUsingCallable</span></code> share many similarities: They both represent a computation that can be done on a part of an array, they both use a dedicated class to store their results, and they both support the operation <code class="docutils literal notranslate"><span class="pre">combine()</span></code> to merge partial results. However, the <a class="reference internal" href="#pool-multiple-blocks"><span class="std std-ref">source code to compute the minimum/maximum</span></a> must be adapted for each of them.</p>
<p>Implement a hierarchy of classes/interfaces that can be used to implement a single source code that is compatible with both <code class="docutils literal notranslate"><span class="pre">MinMaxBlockCallable</span></code> and <code class="docutils literal notranslate"><span class="pre">MeanUsingCallable</span></code>. Furthermore, validate your approach by demonstrating its compatibility with the computation of the standard deviation.</p>
<p>Hint: Standard deviation can be derived from the variance, which can be computed from the number of elements in the block, from the sum of elements in the block, and from the sum of the squared elements in the block: <a class="reference external" href="https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance">https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance</a> (cf. naive algorithm).</p>
</div>
</section>
</section>
<section id="shared-memory">
<h2>Shared memory<a class="headerlink" href="#shared-memory" title="Permalink to this heading">¶</a></h2>
<p>In the solutions presented so far, the strategy was to make <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> or <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> responsible for computing the partial results, then to make the main Java thread responsible to combine those partial results. But, <a class="reference internal" href="#multithreading"><span class="std std-ref">as explained earlier</span></a>, threads that belong to the same process share the same memory space. This means that <strong>threads can access the same variables</strong>.</p>
<section id="using-a-shared-variable-to-collect-the-partial-results">
<span id="shared-partial"></span><h3>Using a shared variable to collect the partial results<a class="headerlink" href="#using-a-shared-variable-to-collect-the-partial-results" title="Permalink to this heading">¶</a></h3>
<p>According to this discussion, it should be possible to make the threads merge <em>directly</em> their partial results into a shared variable, freeing the main thread from this combination task. This is a perfectly valid idea, that is implemented in the following <code class="docutils literal notranslate"><span class="pre">Runnable</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SharedMinMaxComputation</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SharedMinMaxComputation</span><span class="p">(</span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">target</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">float</span><span class="o">[]</span><span class="w"> </span><span class="n">values</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">int</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">startIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">startIndex</span><span class="o">]</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">endIndex</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">target</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SharedMinMaxComputation</span></code> can be executed exactly the same way as <code class="docutils literal notranslate"><span class="pre">MinMaxBlockComputation</span></code> (cf. <a class="reference internal" href="#minmaxresult"><span class="std std-ref">above</span></a>), except that the main Java thread has to create the <code class="docutils literal notranslate"><span class="pre">target</span></code> variable and to provide it to the individual <code class="docutils literal notranslate"><span class="pre">Runnable</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>

<span class="w">    </span><span class="n">SharedMinMaxComputation</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxComputation</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">SharedMinMaxComputation</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxComputation</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// No more call to &quot;combine()&quot; here!</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that it does not make much sense to use a <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> in this approach. Indeed, because the individual computations directly merge their partial results with a shared variable, they never have to report a result to their caller. However, it still makes much sense to use a thread pool to avoid manipulating the threads directly.</p>
<p>This is why the standard interface <code class="docutils literal notranslate"><span class="pre">ExecutorService</span></code> that <a class="reference internal" href="#thread-pools"><span class="std std-ref">implements thread pools</span></a> accepts not only implementations of the <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> interface in its <code class="docutils literal notranslate"><span class="pre">submit()</span></code> method, but also implementations of the <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> interface. In this case, the futures do not convey any result, so <code class="docutils literal notranslate"><span class="pre">Future&lt;T&gt;</span></code> must simply be replaced by <code class="docutils literal notranslate"><span class="pre">Future</span></code>. This is illustrated in the following code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="p">,</span><span class="w"> </span><span class="n">ExecutionException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Fill the array</span>

<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

<span class="w">    </span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>

<span class="w">    </span><span class="n">SharedMinMaxComputation</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxComputation</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="n">SharedMinMaxComputation</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxComputation</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="w">    </span><span class="n">Future</span><span class="w"> </span><span class="n">future1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Future</span><span class="w"> </span><span class="n">future2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>

<span class="w">    </span><span class="n">future1</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">  </span><span class="c1">// The &quot;Future&quot; does not convey any result, so we just wait here</span>
<span class="w">    </span><span class="n">future2</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>

<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="race-conditions-mutual-exclusion-and-monitors">
<h3>Race conditions, mutual exclusion, and monitors<a class="headerlink" href="#race-conditions-mutual-exclusion-and-monitors" title="Permalink to this heading">¶</a></h3>
<p>There is however an important danger in the use of shared variables! Let us consider the following code, in which two threads are incrementing the same counter:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BadCounter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Both threads use the same counter</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incrementCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Counter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nd">@Override</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">incrementCounter</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Counter</span><span class="p">());</span>
<span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Counter</span><span class="p">());</span>
<span class="w">        </span><span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">        </span><span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">        </span><span class="n">t1</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">        </span><span class="n">t2</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">counter</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>One would expect that at the end of the computation, the software would print <code class="docutils literal notranslate"><span class="pre">200000</span></code>: The two threads count from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">100000</span></code>, so the result should be <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">100000</span></code>. However, if you run this software, the printed result is different between each execution and is never equal to <code class="docutils literal notranslate"><span class="pre">200000</span></code> (it is even closer to <code class="docutils literal notranslate"><span class="pre">100000</span></code> than to <code class="docutils literal notranslate"><span class="pre">200000</span></code>). Why so?</p>
<p>This is because of <strong>race conditions</strong>. The line <code class="docutils literal notranslate"><span class="pre">counter++</span></code> actually corresponds to 3 low-level instructions:</p>
<ol class="arabic simple">
<li><p>Read the value of the variable <code class="docutils literal notranslate"><span class="pre">counter</span></code>,</p></li>
<li><p>Add 1 to the read value,</p></li>
<li><p>Store the incremented value to the variable <code class="docutils literal notranslate"><span class="pre">counter</span></code>.</p></li>
</ol>
<p>This decomposition implies that the following sequence of low-level instructions can happen:</p>
<a class="reference internal image-reference" href="_images/race-condition.png"><img alt="Race condition" class="align-center" src="_images/race-condition.png" style="width: 320px;" /></a>
<p>In such a sequence, the first thread would overwrite the change made by the second thread to <code class="docutils literal notranslate"><span class="pre">counter</span></code>: There is an interference between the two threads! Race conditions depend on the way the instructions are dispatched and ordered between the different CPU cores.</p>
<p>Fortunately, operating systems and thread libraries offer primitives to prevent such race conditions to occur. The idea is to define so-called <strong>critical sections</strong> in the source code, in which at most one thread can be present at any time. In our example, method <code class="docutils literal notranslate"><span class="pre">incrementCounter()</span></code> should correspond to a critical section: Thread 1 should have waited for thread 2 to write its result to the shared variable before starting its computation.</p>
<p>In Java, critical sections can be defined by adding the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword to the methods associated with a shared object. Our example can be made correct simply by replacing:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incrementCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>by:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">incrementCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Intuitively, adding the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword means that a thread entering the method “locks a padlock”. As a consequence, any other thread arriving later on cannot enter the method, because the padlock is locked. Once the first thread exits the method, it “unlocks the padlock”, leaving the opportunity to one of the waiting threads to enter the method in its turn.</p>
<p>Internally, each Java object is automatically equipped with one padlock that is shared between all the methods of the object. This padlock is referred to as the <strong>monitor</strong> of the object. The process of locking/unlocking the monitor is referred to as <strong>running in mutual exclusion</strong>.</p>
<p>Another reason for using <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> consists in ensuring the <strong>visibility</strong> of variable modifications done by one thread to the other threads. For instance, let us consider the following source code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Visibility</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ready</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyRunnable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Wait for &quot;ready&quot; to become &quot;true&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Runnable</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyRunnable</span><span class="p">();</span>
<span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;World&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While it may seem obvious that the software will print <code class="docutils literal notranslate"><span class="pre">World</span></code>, it is in fact possible that it will print <code class="docutils literal notranslate"><span class="pre">Hello</span></code>, or never terminate at all! The problem is that the Java specification does not guarantee that some thread sees the modifications made by another thread, unless both threads synchronize (for example with a <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> statement). In other words, the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword also implies that threads <em>publish</em> their changes to other threads.</p>
<p>In the program above, the <code class="docutils literal notranslate"><span class="pre">while</span> <span class="pre">(!ready)</span></code> loop might go on forever because the modification <code class="docutils literal notranslate"><span class="pre">ready</span> <span class="pre">=</span> <span class="pre">true</span></code> done by the main thread might never become visible to <code class="docutils literal notranslate"><span class="pre">MyRunnable</span></code>. Even worse, the JVM might decide to swap the statements <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">=</span> <span class="pre">&quot;World&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">ready</span> <span class="pre">=</span> <span class="pre">true</span></code> in the main thread to apply some low-level hardware optimization: The Java specification allows such <em>reorderings</em>, as long as the reordering does not change the semantics of the code within <em>that</em> thread. As our source code does not enforce the visibility of the changes to <code class="docutils literal notranslate"><span class="pre">ready</span></code>, the JVM will notice that the reordering has no side-effect on the main thread and might decide to first execute <code class="docutils literal notranslate"><span class="pre">ready</span> <span class="pre">=</span> <span class="pre">true</span></code>, which will make <code class="docutils literal notranslate"><span class="pre">MyRunnable</span></code> print <code class="docutils literal notranslate"><span class="pre">Hello</span></code> instead of <code class="docutils literal notranslate"><span class="pre">World</span></code>.</p>
<p>The solution is to make sure that the two threads access the shared variables only through <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> methods, as in the following source code:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FixedVisibility</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ready</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">newName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newName</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isReady</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ready</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyRunnable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isReady</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Wait for &quot;ready&quot; to become &quot;true&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getName</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Runnable</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyRunnable</span><span class="p">();</span>
<span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

<span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">        </span><span class="n">start</span><span class="p">(</span><span class="s">&quot;World&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Summarizing, as a general rule of thumb in this course, make sure that <strong>shared variables are only accessed through synchronized methods</strong>. This will both prevent race conditions and ensure the visibility of the changes.</p>
<p>There is one main caveat associated with the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword: Because <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> methods limit the concurrency between threads, they also reduce the overall performance of multithreaded software. In other words, synchronized methods represent a <strong>bottleneck</strong> in the execution of a multithreaded software. For instance, you should try and avoid making a complex computation in a <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> method, if possible. Nevertheless, always remember that it is less important to have a program that is <em>fast</em> than a program that <em>works properly</em>! <strong>Correctness is always more important than speed</strong>.</p>
<p>Finally, note that the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword is only the most basic of the multiple synchronization mechanisms for multithreading that are offered by Java. It is however the most important one, as it allows one to develop thread-safe software without diving too much into the complexity of parallel programming. As such, <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> should be mastered by any Java developer. As this course is about the basics of multithreading, more advanced constructions will not be covered.</p>
</section>
<section id="shared-object-for-computing-the-minimum-and-maximum">
<h3>Shared object for computing the minimum and maximum<a class="headerlink" href="#shared-object-for-computing-the-minimum-and-maximum" title="Permalink to this heading">¶</a></h3>
<p>We now apply mutual exclusion to our example of <a class="reference internal" href="#shared-partial"><span class="std std-ref">computing the minimum and maximum using a shared variable</span></a>. Note that in the version that uses the shared <code class="docutils literal notranslate"><span class="pre">result</span></code> variable, the original class <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> was replaced by the <code class="docutils literal notranslate"><span class="pre">SharedMinMaxResult</span></code> class. The latter class is exactly the same as <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code>, but with the addition of the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword in each of its methods:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SharedMinMaxResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">SharedMinMaxResult</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isPresent</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">isPresent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SharedMinMaxResult</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="kc">true</span><span class="w"> </span><span class="cm">/* present */</span><span class="p">,</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="nf">empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="p">(</span><span class="kc">false</span><span class="w"> </span><span class="cm">/* not present */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* dummy min */</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* dummy max */</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isPresent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">isPresent</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">minValue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMaxValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">maxValue</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">getMaxValue</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Empty array&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">with</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="p">.</span><span class="na">isPresent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isPresent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Combine the results from two non-empty blocks</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">min</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">minValue</span><span class="p">);</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="n">maxValue</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">maxValue</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Replace the currently absent result by the provided result</span>
<span class="w">                </span><span class="n">isPresent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                </span><span class="n">minValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">minValue</span><span class="p">;</span>
<span class="w">                </span><span class="n">maxValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="p">.</span><span class="na">maxValue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Do nothing if the other result is absent</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The addition of <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> prevents any race condition between the threads when they combine their partial results with the final result. Also note that the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> methods are only part of the class holding the final result: The threads still make their computation in full parallelism. It is only when the partial results are combined that mutual exclusion occurs, which does not represent a large bottleneck.</p>
<p>The downside of this source code is that the classes <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> and <code class="docutils literal notranslate"><span class="pre">SharedMinMaxResult</span></code> share almost all of their source code, which is highly redundant. One could avoid this redundancy by wrapping an object of class <code class="docutils literal notranslate"><span class="pre">MinMaxResult</span></code> inside a class with the same set of methods, but with the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword added:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">SharedMinMaxResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">wrapped</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">SharedMinMaxResult</span><span class="p">(</span><span class="n">MinMaxResult</span><span class="w"> </span><span class="n">wrapped</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapped</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SharedMinMaxResult</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">minValue</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">float</span><span class="w"> </span><span class="n">maxValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MinMaxResult</span><span class="p">(</span><span class="n">minValue</span><span class="p">,</span><span class="w"> </span><span class="n">maxValue</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="nf">empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SharedMinMaxResult</span><span class="p">(</span><span class="n">MinMaxResult</span><span class="p">.</span><span class="na">empty</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isPresent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wrapped</span><span class="p">.</span><span class="na">isPresent</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMinValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wrapped</span><span class="p">.</span><span class="na">getMinValue</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getMaxValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wrapped</span><span class="p">.</span><span class="na">getMaxValue</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wrapped</span><span class="p">.</span><span class="na">print</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">combine</span><span class="p">(</span><span class="n">SharedMinMaxResult</span><span class="w"> </span><span class="n">with</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wrapped</span><span class="p">.</span><span class="na">combine</span><span class="p">(</span><span class="n">with</span><span class="p">.</span><span class="na">wrapped</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="application-to-matrix-multiplication">
<span id="matrix-multiplication"></span><h3>Application to matrix multiplication<a class="headerlink" href="#application-to-matrix-multiplication" title="Permalink to this heading">¶</a></h3>
<p>Linear algebra is a mathematical domain that can greatly benefit from parallel programming. This section gives an example about how multithreading can be used to implement matrix multiplication.</p>
<p>Let us consider the following basic implementation of a matrix in Java:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SynchronizedMatrix</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">values</span><span class="o">[][]</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkPosition</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">getRows</span><span class="p">()</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">column</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">getColumns</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">SynchronizedMatrix</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">int</span><span class="w"> </span><span class="n">columns</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rows</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="n">columns</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="o">[</span><span class="n">rows</span><span class="o">][</span><span class="n">columns</span><span class="o">]</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getRows</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getColumns</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// &quot;values[0]&quot; is guaranteed to exist, because &quot;columns &gt; 0&quot; in the constructor</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">checkPosition</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">values</span><span class="o">[</span><span class="n">row</span><span class="o">][</span><span class="n">column</span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">synchronized</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                                      </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">,</span>
<span class="w">                                      </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">checkPosition</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>
<span class="w">        </span><span class="n">values</span><span class="o">[</span><span class="n">row</span><span class="o">][</span><span class="n">column</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">SynchronizedMatrix</span></code> class has each of its methods tagged with the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword, so it is suitable for use as a shared variable between multiple threads.</p>
<p>We are interested in the task of computing the product <img class="math" src="_images/math/a21840b51caea373fa6d1c48596ff16142373bcd.svg" alt="C \in \mathbb{R}^{m\times p}"/> of two matrices <img class="math" src="_images/math/cb2fb7b2b42686436ac05bfc8ff85a907dcfa309.svg" alt="A \in \mathbb{R}^{m\times n}"/> and <img class="math" src="_images/math/d5eaf33fcc26b2f4fd4302deab7e6a5f0c8a8903.svg" alt="B \in \mathbb{R}^{n\times p}"/> of compatible dimensions. Remember the definition of matrix multiplication: <img class="math" src="_images/math/84c14cf5a217adc92b30da59bf67eff69d44068c.svg" alt="c_{ij} = \sum_{k=1}^{n} a_{ik} b_{kj}"/>. This definition can directly be turned into a sequential algorithm:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="c1">// Fill a and b</span>

<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">getRows</span><span class="p">(),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getColumns</span><span class="p">());</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">getRows</span><span class="p">();</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">column</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">accumulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">accumulator</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">c</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">,</span><span class="w"> </span><span class="n">accumulator</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>How could we leverage multithreading to speed up this computation? The main observation is that the innermost loop on <code class="docutils literal notranslate"><span class="pre">k</span></code> is executed for each entry of <img class="math" src="_images/math/4db5b6e16e06f929ce3f675c5e535d06ffb02ff7.svg" alt="C"/>. Therefore, a possible solution consists in creating <img class="math" src="_images/math/63fb3cf8f5833fbc2437ebc977b348d2b882ef17.svg" alt="m\times p"/> tasks that will be processed by a thread pool, each of these tasks implementing the innermost loop with the accumulator.</p>
<p>A first possible implementation consists in creating a “result” data structure that will store the value of one cell of the matrix product:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ProductAtCellResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">    </span><span class="n">ProductAtCellResult</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">float</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getRow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getColumn</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can then implement the <code class="docutils literal notranslate"><span class="pre">Callable&lt;T&gt;</span></code> interface to use this data structure in a thread pool:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ComputeProductAtCell</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">ProductAtCellResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ComputeProductAtCell</span><span class="p">(</span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">                                </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="p">,</span>
<span class="w">                                </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                                </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ProductAtCellResult</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">accumulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">accumulator</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProductAtCellResult</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">,</span><span class="w"> </span><span class="n">accumulator</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The thread pool would then be used as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ExecutionException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="c1">// Fill a and b</span>

<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="n">Stack</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">ProductAtCellResult</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pendingComputations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stack</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getRows</span><span class="p">();</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">column</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ComputeProductAtCell</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">getRows</span><span class="p">(),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getColumns</span><span class="p">());</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">ProductAtCellResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getRow</span><span class="p">(),</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getColumn</span><span class="p">(),</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getValue</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that this implementation would also work fine if there were no <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword in the class implementing matrices, because the threads do not apply modifications to shared variables. Even though this solution works fine, it is demanding in terms of memory. Indeed, the row, column, and value of each cell in the product will first be stored in a separate data structure (the stack of futures referring to <code class="docutils literal notranslate"><span class="pre">ProductAtCellResult</span></code> objects), before being copied onto the target matrix <code class="docutils literal notranslate"><span class="pre">c</span></code>. Couldn’t the results be directly written into <code class="docutils literal notranslate"><span class="pre">c</span></code>?</p>
<p>The answer is obviously “yes”: Thanks to the fact that the <code class="docutils literal notranslate"><span class="pre">SynchronizedMatrix</span></code> implements the <code class="docutils literal notranslate"><span class="pre">synchronized</span></code> keyword, it is thread-safe and it can be used as a shared variable into which the different threads can directly write their results.</p>
<p>According to this discussion, here is a second possible implementation that replaces <code class="docutils literal notranslate"><span class="pre">Callable&lt;ProductAtCellResult&gt;</span></code> by a set of <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> objects, each of those objects writing one cell of the target matrix:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StoreProductAtCell</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">StoreProductAtCell</span><span class="p">(</span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
<span class="w">                              </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="p">,</span>
<span class="w">                              </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">c</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="p">,</span>
<span class="w">                              </span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">column</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">accumulator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">accumulator</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getValue</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">,</span><span class="w"> </span><span class="n">accumulator</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Thanks to the <code class="docutils literal notranslate"><span class="pre">StoreProductAtCell</span></code> class, the matrix multiplication can be computed by a thread pool as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">args</span><span class="o">[]</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ExecutionException</span><span class="p">,</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(...,</span><span class="w"> </span><span class="p">...);</span>
<span class="w">    </span><span class="c1">// Fill a and b</span>

<span class="w">    </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="n">Stack</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pendingComputations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Stack</span><span class="o">&lt;&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">SynchronizedMatrix</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SynchronizedMatrix</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="na">getRows</span><span class="p">(),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getColumns</span><span class="p">());</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">getRows</span><span class="p">();</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">getColumns</span><span class="p">();</span><span class="w"> </span><span class="n">column</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">StoreProductAtCell</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">column</span><span class="p">)));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Future</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingComputations</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span>
<span class="w">        </span><span class="n">future</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="na">shutdown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that in the specific example of matrix multiplication, the solution based on <code class="docutils literal notranslate"><span class="pre">Runnable</span></code> is both simpler and more memory efficient, as it does not require the use of an intermediate class such as <code class="docutils literal notranslate"><span class="pre">ProductAtCellResult</span></code> to store the partial results before writing them onto the target matrix.</p>
<div class="remark admonition">
<p class="admonition-title">Remark</p>
<p>In practice, the parallel implementation of matrix multiplication proposed above will probably have really bad performance, possibly even worse than a purely sequential algorithm. Indeed, this implementation totally neglects the <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_(computing)">processor cache</a>: Because the various threads work on different areas of the matrices, the CPU will continuously have to access the RAM, which slows down the computation. Real software libraries for optimized linear algebra implement algorithms that feature <strong>locality</strong> in their patterns of access to the RAM. Because CPU cores include a cache memory that is much faster than the RAM, exploiting locality can dramatically increase the performance of an algorithm. Such optimized algorithms will typically leverage <a class="reference external" href="https://en.wikipedia.org/wiki/Block_matrix#Block_matrix_multiplication">block matrix multiplication</a> and <a class="reference external" href="https://fr.wikipedia.org/wiki/Single_instruction_multiple_data">SIMD instructions</a>, in addition to multithreading.</p>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/lepl1402.png" alt="Logo"/>
            </a></p>
<h3><a href="index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="part1.html">From Python to Java</a></li>
<li class="toctree-l1"><a class="reference internal" href="part2.html">Object-Oriented Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="part3.html">Unit testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="part4.html">Algorithms and Data Structures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Parallel Programming</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#gpus-vs-cpus">GPUs vs. CPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiprocessing-vs-multithreading">Multiprocessing vs. multithreading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#threads-in-java">Threads in Java</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thread-pools">Thread pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shared-memory">Shared memory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="part6.html">Functional Programming</a></li>
</ul>

  <div>
    <h3><a href="index.html">Download the book</a></h3>
    <a href="_static/lepl1402.pdf">PDF version of the book</a>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="part6.html" title="Functional Programming"
             >next</a> |</li>
        <li class="right" >
          <a href="part4.html" title="Algorithms and Data Structures"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">LEPL1402  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Parallel Programming</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Sébastien Jodogne, Ramin Sadre, Pierre Schaus.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.2.2.
    </div>
<div class="footer">
    <script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

<script>
//open external links in a new window
function external_new_window() {
    for(var c = document.getElementsByTagName("a"), a = 0;a < c.length;a++) {
        var b = c[a];
        if(b.getAttribute("href") && b.hostname !== location.hostname) {
            b.target = "_blank";
            b.rel = "noopener";
        }
    }
}
//open PDF links in a new window
function pdf_new_window ()
{
    if (!document.getElementsByTagName) return false;
    var links = document.getElementsByTagName("a");
    for (var eleLink=0; eleLink < links.length; eleLink ++) {
    if ((links[eleLink].href.indexOf('.pdf') !== -1)||(links[eleLink].href.indexOf('.doc') !== -1)||(links[eleLink].href.indexOf('.docx') !== -1)) {
        links[eleLink].onclick =
        function() {
            window.open(this.href);
            return false;
        }
    }
    }
}
pdf_new_window();
external_new_window();
</script>


  </body>
</html>